<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>絵文字リアクション積み重ね</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        canvas {
            border: 1px solid #ccc;
            background-color: #fff;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="info">絵文字読み込み中...</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.18.0/matter.min.js"></script>
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyPUFN0slw8c8N99Bk1N_HKYeEwDsWa9ZK_NGx7548934QJxo8uZ-hIg9UuJjtNiMx03g/exec';
        const ENGINE_HEIGHT = 600;
        const ENGINE_WIDTH = 800;

        // ★★★ ここに絵文字と画像URLのマップを追加 ★★★
        const emojiImageMap = {
            '💖': 'images/1f496.png', // ★要修正: あなたのファイルパスに合わせる★
            '✨': 'images/2728.png', // ★要修正: あなたのファイルパスに合わせる★
            '😊': 'images/263a.png',   // もしあれば追加
            '🥰': 'images/1f970.png',     // もしあれば追加
            // 他の絵文字もここに追加
        };

        var Engine = Matter.Engine,
            Render = Matter.Render,
            Runner = Matter.Runner,
            Bodies = Matter.Bodies,
            Composite = Matter.Composite,
            Events = Matter.Events;

        var engine = Engine.create();
        engine.world.gravity.y = 1;

        var render = Render.create({
            element: document.body,
            engine: engine,
            options: {
                width: ENGINE_WIDTH,
                height: ENGINE_HEIGHT,
                wireframes: false,
                background: '#fff'
            }
        });

        Render.run(render);

        var runner = Runner.create();
        Runner.run(runner, engine);

        var ground = Bodies.rectangle(ENGINE_WIDTH / 2, ENGINE_HEIGHT - 25, ENGINE_WIDTH, 50, { isStatic: true, render: { fillStyle: '#666' } });
        var leftWall = Bodies.rectangle(25, ENGINE_HEIGHT / 2, 50, ENGINE_HEIGHT, { isStatic: true, render: { fillStyle: '#666' } });
        var rightWall = Bodies.rectangle(ENGINE_WIDTH - 25, ENGINE_HEIGHT / 2, 50, ENGINE_HEIGHT, { isStatic: true, render: { fillStyle: '#666' } });

        Composite.add(engine.world, [ground, leftWall, rightWall]);

        // 絵文字をランダムな位置に追加する関数
        function addEmojiBody(emojiText) {
            const emojiSize = Math.random() * (40 - 20) + 20;
            const imageUrl = emojiImageMap[emojiText]; // 絵文字に対応する画像URLを取得

            if (!imageUrl) {
                console.warn(`Warning: Image not found for emoji: ${emojiText}. Falling back to red circle.`);
                // 画像が見つからない場合は赤い円を表示（デバッグ用）
                var emojiBody = Bodies.circle(
                    Matter.Common.random(50, ENGINE_WIDTH - 50),
                    50,
                    emojiSize / 2,
                    {
                        restitution: 0.3,
                        friction: 0.5,
                        render: {
                            fillStyle: '#FF0000'
                        }
                    }
                );
            } else {
                // 画像として描画
                var emojiBody = Bodies.circle(
                    Matter.Common.random(50, ENGINE_WIDTH - 50),
                    50,
                    emojiSize / 2, // 半径 (circleの場合、画像に合わせて調整が必要になることも)
                    {
                        restitution: 0.3,
                        friction: 0.5,
                        render: {
                            sprite: {
                                texture: imageUrl, // ★★★ ここに画像URLを設定 ★★★
                                xScale: emojiSize / 64, // 画像の元のサイズ（例: 64px）に合わせて調整
                                yScale: emojiSize / 64
                            }
                        }
                    }
                );
            }
            Composite.add(engine.world, emojiBody);
        }

        async function fetchAndRenderEmojis() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();

                const infoDiv = document.getElementById('info');
                if (data.error) {
                    infoDiv.textContent = `エラー: ${data.error}`;
                    console.error('APIエラー:', data.error);
                    return;
                }

                if (!data.data || data.data.length === 0) {
                    infoDiv.textContent = 'まだ絵文字リアクションがありません。';
                    return;
                }

                const emojiCounts = {};
                data.data.forEach(item => {
                    const emoji = item.Emoji;
                    emojiCounts[emoji] = (emojiCounts[emoji] || 0) + 1;
                });

                let totalEmojisAdded = 0;
                for (const emoji in emojiCounts) {
                    for (let i = 0; i < emojiCounts[emoji]; i++) {
                        setTimeout(() => {
                            addEmojiBody(emoji);
                        }, totalEmojisAdded * 50);
                        totalEmojisAdded++;
                    }
                }
                infoDiv.textContent = `合計 ${totalEmojisAdded} 個の絵文字が降ってきました！`;

            } catch (error) {
                const infoDiv = document.getElementById('info');
                infoDiv.textContent = 'データの取得に失敗しました。コンソールを確認してください。';
                console.error('データ取得エラー:', error);
            }
        }

        fetchAndRenderEmojis();
        // setInterval(fetchAndRenderEmojis, 60000);
    </script>
</body>
</html>