<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµµæ–‡å­—ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç©ã¿é‡ã­</title>
    <style>
        body {
            margin: 0;
            overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
            background-color: #f0f0f0; /* èƒŒæ™¯è‰² */
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        canvas {
            border: 1px solid #ccc; /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã®å¢ƒç•Œç·š */
            background-color: #fff; /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã®èƒŒæ™¯ */
            /* â˜…â˜…â˜… è¿½åŠ /ä¿®æ­£ã™ã‚‹CSS â˜…â˜…â˜… */
            max-width: 100%; /* è¦ªè¦ç´ ã®å¹…ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ã™ã‚‹ */
            height: auto;    /* å¹…ã«åˆã‚ã›ã¦é«˜ã•ã‚’è‡ªå‹•èª¿æ•´ */
            display: block;  /* ä¸­å¤®å¯„ã›ã®ãŸã‚ */
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="info">çµµæ–‡å­—èª­ã¿è¾¼ã¿ä¸­...</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.18.0/matter.min.js"></script>
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyPUFN0slw8c8N99Bk1N_HKYeEwDsWa9ZK_NGx7548934QJxo8uZ-hIg9UuJjtNiMx03g/exec'; // ã‚ãªãŸã®Apps Script APIã®URL

        // åˆæœŸè¨­å®šã®Canvasã‚µã‚¤ã‚º (PCè¡¨ç¤ºã®åŸºæº–ã¨ã™ã‚‹)
        const INITIAL_ENGINE_WIDTH = 800;
        const INITIAL_ENGINE_HEIGHT = 600;

        // Matter.js ã®åˆæœŸåŒ–
        var Engine = Matter.Engine,
            Render = Matter.Render,
            Runner = Matter.Runner,
            Bodies = Matter.Bodies,
            Composite = Matter.Composite,
            Events = Matter.Events;

        var engine = Engine.create();
        engine.world.gravity.y = 1;

        var render = Render.create({
            element: document.body,
            engine: engine,
            options: {
                width: INITIAL_ENGINE_WIDTH, // åˆæœŸå€¤ã‚’è¨­å®š
                height: INITIAL_ENGINE_HEIGHT, // åˆæœŸå€¤ã‚’è¨­å®š
                wireframes: false,
                background: '#fff'
            }
        });

        Render.run(render);

        var runner = Runner.create();
        Runner.run(runner, engine);

        // åœ°é¢ã¨å£ã‚’ä½œæˆ (ã“ã‚Œã‚‰ã®ä½ç½®ã‚‚å‹•çš„ã«èª¿æ•´ã™ã‚‹å¿…è¦ãŒã‚ã‚‹)
        // ã¾ãšã¯æ—¢å­˜ã®è¦ç´ ã‚’ã‚¯ãƒªã‚¢
        Composite.clear(engine.world);

        // â˜…â˜…â˜… Canvasã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦åœ°é¢ã¨å£ã‚’å†æ§‹ç¯‰ã™ã‚‹é–¢æ•° â˜…â˜…â˜…
        function setupBoundaries() {
            // æ—¢å­˜ã®å¢ƒç•Œã‚’å‰Šé™¤ (ãƒªã‚µã‚¤ã‚ºæ™‚ã«é‡è¤‡ã—ãªã„ã‚ˆã†ã«)
            Composite.remove(engine.world, engine.world.bodies.filter(body => body.isStatic));

            const currentWidth = render.options.width;
            const currentHeight = render.options.height;

            var ground = Bodies.rectangle(currentWidth / 2, currentHeight - 25, currentWidth, 50, { isStatic: true, render: { fillStyle: '#666' } });
            var leftWall = Bodies.rectangle(25, currentHeight / 2, 50, currentHeight, { isStatic: true, render: { fillStyle: '#666' } });
            var rightWall = Bodies.rectangle(currentWidth - 25, currentHeight / 2, 50, currentHeight, { isStatic: true, render: { fillStyle: '#666' } });

            Composite.add(engine.world, [ground, leftWall, rightWall]);
        }

        // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«å¢ƒç•Œã‚’è¨­å®š
        setupBoundaries();


        // çµµæ–‡å­—ã¨ç”»åƒURLã®ãƒãƒƒãƒ—ï¼ˆä»¥å‰ã®ã‚ãªãŸã®è¨­å®šï¼‰
        const emojiImageMap = {

            'ğŸ’–': 'images/1f496.png', // â˜…è¦ä¿®æ­£: ã‚ãªãŸã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã«åˆã‚ã›ã‚‹â˜…
            'âœ¨': 'images/2728.png', // â˜…è¦ä¿®æ­£: ã‚ãªãŸã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã«åˆã‚ã›ã‚‹â˜…
            'ğŸ˜Š': 'images/263a.png',  // ã‚‚ã—ã‚ã‚Œã°è¿½åŠ 
            'ğŸ¥°': 'images/1f970.png',  // ã‚‚ã—ã‚ã‚Œã°è¿½åŠ 
            // ä»–ã®çµµæ–‡å­—ã‚‚ã“ã“ã«è¿½åŠ 
        };

        function addEmojiBody(emojiText) {
            // çµµæ–‡å­—ã®ã‚µã‚¤ã‚ºã‚’å‹•çš„ã«èª¿æ•´
            const currentWidth = render.options.width;
            const emojiSize = Math.random() * (currentWidth / 20 - currentWidth / 40) + currentWidth / 40; // ç”»é¢å¹…ã«åˆã‚ã›ãŸã‚µã‚¤ã‚ºèª¿æ•´

            const imageUrl = emojiImageMap[emojiText];

            let emojiBody;
            if (!imageUrl) {
                console.warn(`Warning: Image not found for emoji: ${emojiText}. Falling back to red circle.`);
                emojiBody = Bodies.circle(
                    Matter.Common.random(50, currentWidth - 50),
                    50,
                    emojiSize / 2,
                    {
                        restitution: 0.3,
                        friction: 0.5,
                        render: {
                            fillStyle: '#FF0000'
                        }
                    }
                );
            } else {
                emojiBody = Bodies.circle(
                    Matter.Common.random(50, currentWidth - 50),
                    50,
                    emojiSize / 2,
                    {
                        restitution: 0.3,
                        friction: 0.5,
                        render: {
                            sprite: {
                                texture: imageUrl,
                                xScale: emojiSize / 64, // å…ƒç”»åƒã®ã‚µã‚¤ã‚º64pxã‚’åŸºæº–ã«èª¿æ•´
                                yScale: emojiSize / 64
                            }
                        }
                    }
                );
            }
            Composite.add(engine.world, emojiBody);
        }

        async function fetchAndRenderEmojis() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();

                const infoDiv = document.getElementById('info');
                if (data.error) {
                    infoDiv.textContent = `ã‚¨ãƒ©ãƒ¼: ${data.error}`;
                    console.error('APIã‚¨ãƒ©ãƒ¼:', data.error);
                    return;
                }

                if (!data.data || data.data.length === 0) {
                    infoDiv.textContent = 'ã¾ã çµµæ–‡å­—ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
                    return;
                }

                const emojiCounts = {};
                data.data.forEach(item => {
                    const emoji = item.Emoji;
                    emojiCounts[emoji] = (emojiCounts[emoji] || 0) + 1;
                });

                let totalEmojisAdded = 0;
                for (const emoji in emojiCounts) {
                    for (let i = 0; i < emojiCounts[emoji]; i++) {
                        setTimeout(() => {
                            addEmojiBody(emoji);
                        }, totalEmojisAdded * 50);
                        totalEmojisAdded++;
                    }
                }
                infoDiv.textContent = `åˆè¨ˆ ${totalEmojisAdded} å€‹ã®çµµæ–‡å­—ãŒé™ã£ã¦ãã¾ã—ãŸï¼`;

            } catch (error) {
                const infoDiv = document.getElementById('info');
                infoDiv.textContent = 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
        fetchAndRenderEmojis();

        // â˜…â˜…â˜… ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ãƒªã‚µã‚¤ã‚ºã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–ã—ã¦Canvasã‚’èª¿æ•´ â˜…â˜…â˜…
        function resizeCanvas() {
            const containerWidth = window.innerWidth;
            const containerHeight = window.innerHeight;

            // Canvasã®æ–°ã—ã„ã‚µã‚¤ã‚ºã‚’è¨ˆç®—ï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ã¤ã¤ã€ç”»é¢ã«åã¾ã‚‹ã‚ˆã†ã«ï¼‰
            let newWidth, newHeight;
            const aspectRatio = INITIAL_ENGINE_WIDTH / INITIAL_ENGINE_HEIGHT;

            if (containerWidth / containerHeight > aspectRatio) {
                // ç”»é¢ãŒæ¨ªé•·ã™ãã‚‹ã¨ãã¯é«˜ã•ã‚’åŸºæº–ã«ã™ã‚‹
                newHeight = containerHeight;
                newWidth = containerHeight * aspectRatio;
            } else {
                // ç”»é¢ãŒç¸¦é•·ã™ãã‚‹ã¨ãã¯å¹…ã‚’åŸºæº–ã«ã™ã‚‹
                newWidth = containerWidth;
                newHeight = containerWidth / aspectRatio;
            }

            // å¿…è¦ã«å¿œã˜ã¦æœ€å¤§ã‚µã‚¤ã‚ºã‚’åˆ¶é™
            newWidth = Math.min(newWidth, INITIAL_ENGINE_WIDTH);
            newHeight = Math.min(newHeight, INITIAL_ENGINE_HEIGHT);

            // Matter.js ã®ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã®ã‚µã‚¤ã‚ºã‚’æ›´æ–°
            render.options.width = newWidth;
            render.options.height = newHeight;
            render.canvas.width = newWidth;
            render.canvas.height = newHeight;

            // å¢ƒç•Œã‚’å†è¨­å®š
            setupBoundaries();

            // å¿…è¦ã§ã‚ã‚Œã°æ—¢å­˜ã®ãƒœãƒ‡ã‚£ã®ä½ç½®ã‚‚èª¿æ•´ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ  (ä»Šå›ã¯çœç•¥)
            // Composite.allBodies(engine.world).forEach(body => {
            //     // å„ãƒœãƒ‡ã‚£ã®x, yåº§æ¨™ã‚’æ–°ã—ã„Canvasã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦èª¿æ•´
            //     // ç”»é¢ä¸­å¤®ã«ç›¸å¯¾çš„ã«é…ç½®ã™ã‚‹ãªã©
            // });

            Render.setViewPort(render, { // æ­£ã—ã„é–¢æ•°åã¯ Render.setViewPort()
                x: 0,
                y: 0,
                width: newWidth,
                height: newHeight
            });

            // ç‰©ç†ã‚¨ãƒ³ã‚¸ãƒ³ã®é‡åŠ›ã‚‚èª¿æ•´ã§ãã‚‹ãŒã€ä»Šå›ã¯å›ºå®š
            // engine.world.gravity.x = 0;
            // engine.world.gravity.y = 1;
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã¨ãƒªã‚µã‚¤ã‚ºæ™‚ã«Canvasã‚µã‚¤ã‚ºã‚’è¨­å®š
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas(); // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚‚å®Ÿè¡Œ

    </script>
</body>
</html>