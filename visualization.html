<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµµæ–‡å­—ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç©ã¿é‡ã­</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        canvas {
            border: 1px solid #ccc;
            background-color: #fff;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="info">çµµæ–‡å­—èª­ã¿è¾¼ã¿ä¸­...</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.18.0/matter.min.js"></script>
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyPUFN0slw8c8N99Bk1N_HKYeEwDsWa9ZK_NGx7548934QJxo8uZ-hIg9UuJjtNiMx03g/exec';
        const ENGINE_HEIGHT = 600;
        const ENGINE_WIDTH = 800;

        // â˜…â˜…â˜… ã“ã“ã«çµµæ–‡å­—ã¨ç”»åƒURLã®ãƒãƒƒãƒ—ã‚’è¿½åŠ  â˜…â˜…â˜…
        const emojiImageMap = {
            'ğŸ’–': 'images/1f496.png', // â˜…è¦ä¿®æ­£: ã‚ãªãŸã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã«åˆã‚ã›ã‚‹â˜…
            'âœ¨': 'images/2728.png', // â˜…è¦ä¿®æ­£: ã‚ãªãŸã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã«åˆã‚ã›ã‚‹â˜…
            'ğŸ˜Š': 'images/263a.png',   // ã‚‚ã—ã‚ã‚Œã°è¿½åŠ 
            'ğŸ¥°': 'images/1f970.png',     // ã‚‚ã—ã‚ã‚Œã°è¿½åŠ 
            // ä»–ã®çµµæ–‡å­—ã‚‚ã“ã“ã«è¿½åŠ 
        };

        var Engine = Matter.Engine,
            Render = Matter.Render,
            Runner = Matter.Runner,
            Bodies = Matter.Bodies,
            Composite = Matter.Composite,
            Events = Matter.Events;

        var engine = Engine.create();
        engine.world.gravity.y = 1;

        var render = Render.create({
            element: document.body,
            engine: engine,
            options: {
                width: ENGINE_WIDTH,
                height: ENGINE_HEIGHT,
                wireframes: false,
                background: '#fff'
            }
        });

        Render.run(render);

        var runner = Runner.create();
        Runner.run(runner, engine);

        var ground = Bodies.rectangle(ENGINE_WIDTH / 2, ENGINE_HEIGHT - 25, ENGINE_WIDTH, 50, { isStatic: true, render: { fillStyle: '#666' } });
        var leftWall = Bodies.rectangle(25, ENGINE_HEIGHT / 2, 50, ENGINE_HEIGHT, { isStatic: true, render: { fillStyle: '#666' } });
        var rightWall = Bodies.rectangle(ENGINE_WIDTH - 25, ENGINE_HEIGHT / 2, 50, ENGINE_HEIGHT, { isStatic: true, render: { fillStyle: '#666' } });

        Composite.add(engine.world, [ground, leftWall, rightWall]);

        // çµµæ–‡å­—ã‚’ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã«è¿½åŠ ã™ã‚‹é–¢æ•°
        function addEmojiBody(emojiText) {
            const emojiSize = Math.random() * (40 - 20) + 20;
            const imageUrl = emojiImageMap[emojiText]; // çµµæ–‡å­—ã«å¯¾å¿œã™ã‚‹ç”»åƒURLã‚’å–å¾—

            if (!imageUrl) {
                console.warn(`Warning: Image not found for emoji: ${emojiText}. Falling back to red circle.`);
                // ç”»åƒãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯èµ¤ã„å††ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                var emojiBody = Bodies.circle(
                    Matter.Common.random(50, ENGINE_WIDTH - 50),
                    50,
                    emojiSize / 2,
                    {
                        restitution: 0.3,
                        friction: 0.5,
                        render: {
                            fillStyle: '#FF0000'
                        }
                    }
                );
            } else {
                // ç”»åƒã¨ã—ã¦æç”»
                var emojiBody = Bodies.circle(
                    Matter.Common.random(50, ENGINE_WIDTH - 50),
                    50,
                    emojiSize / 2, // åŠå¾„ (circleã®å ´åˆã€ç”»åƒã«åˆã‚ã›ã¦èª¿æ•´ãŒå¿…è¦ã«ãªã‚‹ã“ã¨ã‚‚)
                    {
                        restitution: 0.3,
                        friction: 0.5,
                        render: {
                            sprite: {
                                texture: imageUrl, // â˜…â˜…â˜… ã“ã“ã«ç”»åƒURLã‚’è¨­å®š â˜…â˜…â˜…
                                xScale: emojiSize / 64, // ç”»åƒã®å…ƒã®ã‚µã‚¤ã‚ºï¼ˆä¾‹: 64pxï¼‰ã«åˆã‚ã›ã¦èª¿æ•´
                                yScale: emojiSize / 64
                            }
                        }
                    }
                );
            }
            Composite.add(engine.world, emojiBody);
        }

        async function fetchAndRenderEmojis() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();

                const infoDiv = document.getElementById('info');
                if (data.error) {
                    infoDiv.textContent = `ã‚¨ãƒ©ãƒ¼: ${data.error}`;
                    console.error('APIã‚¨ãƒ©ãƒ¼:', data.error);
                    return;
                }

                if (!data.data || data.data.length === 0) {
                    infoDiv.textContent = 'ã¾ã çµµæ–‡å­—ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
                    return;
                }

                const emojiCounts = {};
                data.data.forEach(item => {
                    const emoji = item.Emoji;
                    emojiCounts[emoji] = (emojiCounts[emoji] || 0) + 1;
                });

                let totalEmojisAdded = 0;
                for (const emoji in emojiCounts) {
                    for (let i = 0; i < emojiCounts[emoji]; i++) {
                        setTimeout(() => {
                            addEmojiBody(emoji);
                        }, totalEmojisAdded * 50);
                        totalEmojisAdded++;
                    }
                }
                infoDiv.textContent = `åˆè¨ˆ ${totalEmojisAdded} å€‹ã®çµµæ–‡å­—ãŒé™ã£ã¦ãã¾ã—ãŸï¼`;

            } catch (error) {
                const infoDiv = document.getElementById('info');
                infoDiv.textContent = 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        fetchAndRenderEmojis();
        // setInterval(fetchAndRenderEmojis, 60000);
    </script>
</body>
</html>